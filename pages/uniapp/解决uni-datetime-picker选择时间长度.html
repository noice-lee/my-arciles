<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>背景 | 不加冰</title>
    <meta name="generator" content="VuePress 1.9.7">
    
    <meta name="description" content="">
    
    <link rel="preload" href="/my-articles/assets/css/0.styles.82ef5590.css" as="style"><link rel="preload" href="/my-articles/assets/js/app.81fc1dc5.js" as="script"><link rel="preload" href="/my-articles/assets/js/2.ceb12996.js" as="script"><link rel="preload" href="/my-articles/assets/js/23.0131d361.js" as="script"><link rel="prefetch" href="/my-articles/assets/js/10.67a63f90.js"><link rel="prefetch" href="/my-articles/assets/js/11.d0f7324b.js"><link rel="prefetch" href="/my-articles/assets/js/12.3e8dcf36.js"><link rel="prefetch" href="/my-articles/assets/js/13.9c4957f7.js"><link rel="prefetch" href="/my-articles/assets/js/14.9252d359.js"><link rel="prefetch" href="/my-articles/assets/js/15.cd45a4f6.js"><link rel="prefetch" href="/my-articles/assets/js/16.fe1038fb.js"><link rel="prefetch" href="/my-articles/assets/js/17.17b64f31.js"><link rel="prefetch" href="/my-articles/assets/js/18.0835cc9b.js"><link rel="prefetch" href="/my-articles/assets/js/19.07d455bd.js"><link rel="prefetch" href="/my-articles/assets/js/20.4714f6d7.js"><link rel="prefetch" href="/my-articles/assets/js/21.9bd84823.js"><link rel="prefetch" href="/my-articles/assets/js/22.bd942afc.js"><link rel="prefetch" href="/my-articles/assets/js/24.c5283022.js"><link rel="prefetch" href="/my-articles/assets/js/25.dc13ac45.js"><link rel="prefetch" href="/my-articles/assets/js/26.f7cfef0f.js"><link rel="prefetch" href="/my-articles/assets/js/3.95632689.js"><link rel="prefetch" href="/my-articles/assets/js/4.a53e086f.js"><link rel="prefetch" href="/my-articles/assets/js/5.d274975c.js"><link rel="prefetch" href="/my-articles/assets/js/6.2ffe46f1.js"><link rel="prefetch" href="/my-articles/assets/js/7.f6c07dd0.js"><link rel="prefetch" href="/my-articles/assets/js/8.27c425c7.js"><link rel="prefetch" href="/my-articles/assets/js/9.5233e708.js">
    <link rel="stylesheet" href="/my-articles/assets/css/0.styles.82ef5590.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/my-articles/" class="home-link router-link-active"><img src="/my-articles/2022-03-24_115321.png" alt="不加冰" class="logo"> <span class="site-name can-hide">不加冰</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/my-articles/pages/notes/01-2022年中.html" class="nav-link">
  随心记
</a></div><div class="nav-item"><a href="/my-articles/pages/vue/插槽、组件.html" class="nav-link">
  Vue学习
</a></div><div class="nav-item"><a href="/my-articles/pages/uniapp/uCharts地图标点.html" class="nav-link">
  uniapp
</a></div><div class="nav-item"><a href="/my-articles/pages/data/队列结构.html" class="nav-link">
  数据结构
</a></div><div class="nav-item"><a href="/my-articles/pages/leetcode/easy/001.两数之和.html" class="nav-link">
  力扣
</a></div><div class="nav-item"><a href="/my-articles/pages/engineering/引入ESLint、Prettier、pre-commit.html" class="nav-link">
  前端工程化
</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/my-articles/pages/notes/01-2022年中.html" class="nav-link">
  随心记
</a></div><div class="nav-item"><a href="/my-articles/pages/vue/插槽、组件.html" class="nav-link">
  Vue学习
</a></div><div class="nav-item"><a href="/my-articles/pages/uniapp/uCharts地图标点.html" class="nav-link">
  uniapp
</a></div><div class="nav-item"><a href="/my-articles/pages/data/队列结构.html" class="nav-link">
  数据结构
</a></div><div class="nav-item"><a href="/my-articles/pages/leetcode/easy/001.两数之和.html" class="nav-link">
  力扣
</a></div><div class="nav-item"><a href="/my-articles/pages/engineering/引入ESLint、Prettier、pre-commit.html" class="nav-link">
  前端工程化
</a></div> <!----></nav>  <ul class="sidebar-links"><li><a href="/my-articles/pages/uniapp/uCharts地图标点.html" class="sidebar-link">uCharts地图标点</a></li><li><a href="/my-articles/pages/uniapp/编译安卓之webview.html" class="sidebar-link">编译安卓之webview</a></li><li><a href="/my-articles/pages/uniapp/解决uni-datetime-picker选择时间长度.html" class="active sidebar-link">uni-datetime-picker选择时间长度</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/my-articles/pages/uniapp/解决uni-datetime-picker选择时间长度.html#背景" class="sidebar-link">背景</a></li><li class="sidebar-sub-header"><a href="/my-articles/pages/uniapp/解决uni-datetime-picker选择时间长度.html#代码分析" class="sidebar-link">代码分析</a></li><li class="sidebar-sub-header"><a href="/my-articles/pages/uniapp/解决uni-datetime-picker选择时间长度.html#解决步骤" class="sidebar-link">解决步骤</a></li></ul></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h2 id="背景"><a href="#背景" class="header-anchor">#</a> 背景</h2> <p><code>uni-datetime-picker</code>支持限制选择时间开始和结束，但不支持限制选择时间范围长度，比如最多可选择一个月，碰到一个需求需要默认可以任意选择，在选择一个日期后最多选择一个月内的日期，因项目是本人自己独立完成，看了看<code>uni-datetime-picker组件</code>源码的逻辑比较清晰、易修改，所以选择直接改源码，并在项目内记录了修改原因和方式</p> <h2 id="代码分析"><a href="#代码分析" class="header-anchor">#</a> 代码分析</h2> <p><code>uni-datetime-picker组件</code>依赖的<code>calendar组件</code>里面有一个插入模式<code>insert</code>，<code>uni-datetime-picker组件</code>里通过判断<code>isPhone</code>时会给<code>insert</code>赋值为<code>false</code>，而在<code>calendar组件</code>里日期变化会触发的<code>change</code>方法中会判断如果不是插入模式就不会派发事件，而在<code>uni-datetime-picker组件</code>里手机端也没有监听<code>change事件</code></p> <blockquote><p>一句话概括就是：只选择一个日期后没有触发回调，来控制修改开始/结束时间</p></blockquote> <h2 id="解决步骤"><a href="#解决步骤" class="header-anchor">#</a> 解决步骤</h2> <h3 id="_1-calendar组件里面的choicedate日期改变事件中触发的change事件-让此事件派发事件"><a href="#_1-calendar组件里面的choicedate日期改变事件中触发的change事件-让此事件派发事件" class="header-anchor">#</a> 1. <code>calendar组件</code>里面的<code>choiceDate</code>日期改变事件中触发的<code>change事件</code>，让此事件派发事件</h3> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token function">choiceDate</span><span class="token punctuation">(</span><span class="token parameter">weeks</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// ……</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>tempRange<span class="token punctuation">.</span>before <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>cale<span class="token punctuation">.</span>multipleStatus<span class="token punctuation">.</span>before
    <span class="token keyword">this</span><span class="token punctuation">.</span>tempRange<span class="token punctuation">.</span>after <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>cale<span class="token punctuation">.</span>multipleStatus<span class="token punctuation">.</span>after
    <span class="token comment">// this.change()</span>
    <span class="token comment">// 改为</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">change</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token function">change</span><span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// if (!this.insert) return </span>
    <span class="token comment">// 改为</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>insert <span class="token operator">&amp;&amp;</span> e <span class="token operator">!==</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token keyword">return</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setEmit</span><span class="token punctuation">(</span><span class="token string">'change'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><h3 id="_2-uni-datetime-picker组件监听对应子组件事件-继续向上派发事件"><a href="#_2-uni-datetime-picker组件监听对应子组件事件-继续向上派发事件" class="header-anchor">#</a> 2. <code>uni-datetime-picker组件</code>监听对应子组件事件，继续向上派发事件</h3> <div class="language-html line-numbers-mode"><pre class="language-html"><code>// 第一步 监听子组件事件
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>calendar</span> 
  <span class="token attr-name">v-show</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>isPhone<span class="token punctuation">&quot;</span></span> 
  <span class="token attr-name">ref</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>mobile<span class="token punctuation">&quot;</span></span> 
  <span class="token attr-name">:clearDate</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>false<span class="token punctuation">&quot;</span></span> 
  <span class="token attr-name">:date</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>defSingleDate<span class="token punctuation">&quot;</span></span> 
  <span class="token attr-name">:defTime</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>reactMobDefTime<span class="token punctuation">&quot;</span></span>
  <span class="token attr-name">:start-date</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>caleRange.startDate<span class="token punctuation">&quot;</span></span>
  <span class="token attr-name">:end-date</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>caleRange.endDate<span class="token punctuation">&quot;</span></span>
  <span class="token attr-name">:selectableTimes</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>mobSelectableTime<span class="token punctuation">&quot;</span></span>
  <span class="token attr-name">:pleStatus</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>endMultipleStatus<span class="token punctuation">&quot;</span></span>
  <span class="token attr-name">:showMonth</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>false<span class="token punctuation">&quot;</span></span>
  <span class="token attr-name">:range</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>isRange<span class="token punctuation">&quot;</span></span>
  <span class="token attr-name">:typeHasTime</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>hasTime<span class="token punctuation">&quot;</span></span>
  <span class="token attr-name">:insert</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>false<span class="token punctuation">&quot;</span></span>
  <span class="token attr-name">:hideSecond</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>hideSecond<span class="token punctuation">&quot;</span></span> 
  <span class="token attr-name">@confirm</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>mobileChange<span class="token punctuation">&quot;</span></span>
<span class="token punctuation">/&gt;</span></span>
// 改为（只添加监听change事件）
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>calendar</span>
  <span class="token attr-name">v-show</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>isPhone<span class="token punctuation">&quot;</span></span>
  <span class="token attr-name">ref</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>mobile<span class="token punctuation">&quot;</span></span> 
  <span class="token attr-name">:clearDate</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>false<span class="token punctuation">&quot;</span></span> 
  <span class="token attr-name">:date</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>defSingleDate<span class="token punctuation">&quot;</span></span> 
  <span class="token attr-name">:defTime</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>reactMobDefTime<span class="token punctuation">&quot;</span></span>
  <span class="token attr-name">:start-date</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>caleRange.startDate<span class="token punctuation">&quot;</span></span> 
  <span class="token attr-name">:end-date</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>caleRange.endDate<span class="token punctuation">&quot;</span></span> 
  <span class="token attr-name">:selectableTimes</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>mobSelectableTime<span class="token punctuation">&quot;</span></span>
  <span class="token attr-name">:pleStatus</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>endMultipleStatus<span class="token punctuation">&quot;</span></span> 
  <span class="token attr-name">:showMonth</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>false<span class="token punctuation">&quot;</span></span> 
  <span class="token attr-name">:range</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>isRange<span class="token punctuation">&quot;</span></span> 
  <span class="token attr-name">:typeHasTime</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>hasTime<span class="token punctuation">&quot;</span></span> 
  <span class="token attr-name">:insert</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>false<span class="token punctuation">&quot;</span></span>
  <span class="token attr-name">:hideSecond</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>hideSecond<span class="token punctuation">&quot;</span></span> 
  <span class="token attr-name">@confirm</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>mobileChange<span class="token punctuation">&quot;</span></span>
  <span class="token attr-name">@change</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>myChange<span class="token punctuation">&quot;</span></span> 
<span class="token punctuation">/&gt;</span></span>
// 第二步 将接受到的数据直接向上派发事件
myChange (e) {
    // console.log(e, 'e')
    this.$emit('myChange', e)
}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br></div></div><h3 id="_3-在自己的组件中监听mychange事件-控制uni-datetime-picker组件的start和end"><a href="#_3-在自己的组件中监听mychange事件-控制uni-datetime-picker组件的start和end" class="header-anchor">#</a> 3. 在自己的组件中监听<code>myChange事件</code>，控制<code>uni-datetime-picker组件</code>的<code>start</code>和<code>end</code></h3> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token operator">&lt;</span>uni<span class="token operator">-</span>datetime<span class="token operator">-</span>picker v<span class="token operator">-</span>model<span class="token operator">=</span><span class="token string">&quot;dateRange&quot;</span> type<span class="token operator">=</span><span class="token string">&quot;daterange&quot;</span> @change<span class="token operator">=</span><span class="token string">&quot;dateRangeChange&quot;</span> @myChange<span class="token operator">=</span><span class="token string">&quot;myChange&quot;</span> <span class="token operator">:</span>start<span class="token operator">=</span><span class="token string">&quot;dateStart&quot;</span> <span class="token operator">:</span>end<span class="token operator">=</span><span class="token string">&quot;dateEnd&quot;</span><span class="token operator">&gt;</span>
​
<span class="token function">myChange</span> <span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 判断如果是只选择了一个日期</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>e<span class="token punctuation">.</span>range<span class="token punctuation">.</span>before <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>e<span class="token punctuation">.</span>range<span class="token punctuation">.</span>after<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 当前选择的日期</span>
        <span class="token comment">// 此处使用dayjs进行操作，也可直接将 e.range.before 转换为时间戳，然后再计算对应的毫秒数进行复制，uni-datetime-picker组件 直接接收时间戳</span>
        <span class="token keyword">const</span> chooseDate <span class="token operator">=</span> <span class="token function">dayjs</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span>range<span class="token punctuation">.</span>before<span class="token punctuation">)</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>dateStart <span class="token operator">=</span> chooseDate<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">'month'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">'YYYY-MM-DD'</span><span class="token punctuation">)</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>dateEnd <span class="token operator">=</span> chooseDate<span class="token punctuation">.</span><span class="token function">subtract</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">'month'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">'YYYY-MM-DD'</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">上次更新:</span> <span class="time">1668738862000</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/my-articles/pages/uniapp/编译安卓之webview.html" class="prev">
        编译安卓之webview
      </a></span> <!----></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/my-articles/assets/js/app.81fc1dc5.js" defer></script><script src="/my-articles/assets/js/2.ceb12996.js" defer></script><script src="/my-articles/assets/js/23.0131d361.js" defer></script>
  </body>
</html>
